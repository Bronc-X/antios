# Anti-Anxiety Closed Loop Architecture Map (antios5)

## Scope Guardrail
- Workspace: `/Users/mac/Desktop/Antianxiety/antios5`
- Legacy untouched: `/Users/mac/Desktop/Antianxiety/antianxietynew`

## Product Loop (Single Home Orchestration)
1. Max proactive inquiry
2. Daily calibration
3. Scientific explanation (RAG evidence)
4. Action closure (executable tasks + follow-up)

## Threaded Refactor Plan

### Thread A: Architecture & Data Contract
- Goal: freeze closed-loop contracts before deep refactor.
- Main files:
  - `antios5/Features/Dashboard/DashboardModels.swift`
  - `antios5/Models/InsightModels.swift`
  - `antios5/Features/Dashboard/DashboardViewModel.swift`
  - `antios5/Core/Networking/SupabaseManager.swift`
- Risk: Medium (contract changes affect many ViewModel decisions).

### Thread B: Data + Intelligence Pipeline
- Goal: HealthKit -> persistence -> user model -> RAG context.
- Main files:
  - `antios5/Core/HealthKit/HealthKitService.swift`
  - `antios5/Core/Networking/SupabaseManager.swift`
  - `antios5/Core/Services/Max/MaxRAGService.swift`
  - `antios5/Features/Report/ReportViewModels.swift`
  - `antios5/Features/Dashboard/DashboardViewModel.swift`
- Risk: High (network + schema coupling).

### Thread C: iOS Interaction and Home Loop
- Goal: home becomes strict anti-anxiety closed loop (no module pile).
- Main files:
  - `antios5/Features/Dashboard/DashboardView.swift`
  - `antios5/Features/Dashboard/DashboardViewModel.swift`
  - `antios5/Core/Services/Max/MaxPromptBuilder.swift`
  - `antios5/ContentView.swift` (only if tab routing needs changes)
- Risk: High (user-facing IA rewrite).

### Thread D: Integration & Regression
- Goal: run compile/test/gate checks and report gaps.
- Main files:
  - `antios5.xcodeproj` (if needed)
  - i18n reports (generated by skill scripts)
- Risk: Medium (toolchain availability dependency).

## Core Data Contracts

### Loop Status Contract
- Type: `AntiAnxietyLoopStatus`
- Fields:
  - `currentStep`
  - `completedSteps`
  - `blockedReasons`
  - `updatedAt`

### Wearable Ingestion Contract
- Type: `AppleWatchIngestionBundle`
- Constraint:
  - source must be Apple Watch/HealthKit only.
- Flow:
  - persist into `user_health_data`
  - fold into `unified_user_profiles.ai_inferred_traits`
  - expose summary for RAG grounding.

### Scientific Soothing Output Contract
- Type: `ScientificSoothingResponse`
- Required sections:
  - understanding conclusion
  - mechanism explanation
  - evidence sources
  - executable actions
  - follow-up question

## Risk Classification
- R1 Low: additive contract types without runtime path switch.
- R2 Medium: loop status gating in dashboard VM.
- R3 High: wearable persistence + profile patch if backend schema drifts.

## Decision Record (A/B cross-supervision)
- Option A: big-bang home rewrite first.
- Option B: contract-first, then data/UX migration.
- Chosen: Option B.
- Reason:
  - user-value first: ensure loop semantics are explicit before UI/data swap;
  - complexity second: avoids coupled regressions in `SupabaseManager`;
  - timeline third: supports incremental runnable milestones.
